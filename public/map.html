<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
		<meta charset="utf-8">
		<title>Reverse Geocoding</title>
		<style>
			html, body, #map-canvas {
			height: 100%;
			margin: 0px;
			padding: 10px
			}
			#panel {
				position: absolute;
				top: 5px; 
				left: 50%;
	 			margin-left: -180px;
				z-index: 5;
				background-color: #fff;
			padding: 5px;
					border: 1px solid #999;
			}
		</style>
		<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
		<script src="http://localhost:3000/socket.io/socket.io.js"></script>
		<script>
			var geocoder;
			var map;
			var infowindow = new google.maps.InfoWindow();
			// var marker = new google.maps.Marker();
			// var marker;
			
			function initialize() {
				geocoder = new google.maps.Geocoder();
				var latlng = new google.maps.LatLng(52.0236377,4.3533367);
				var mapOptions = {
					zoom: 4,
					center: latlng,
					mapTypeId: 'roadmap'
				}
				map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
			}

			google.maps.event.addDomListener(window, 'load', initialize);
		</script>

     	<script>
     		io = io.connect();

     		// TODO: Get the vehicle identification from a GUI
     		var arrayVehicles = [220, 222, 235];
     		var markersHashMap = {};
     		// Initialize the marker's hashMap
     		for (var i = 0; i < arrayVehicles.length; i++) {
     			if(!(i.toString in markersHashMap))
     				markersHashMap[arrayVehicles[i].toString()] = {};
     		};

			// Emit ready event with room name.
			io.emit('getVehicleLocation', arrayVehicles);

			// Listen for the location update event.
			io.on('vehicleInfo', myEvtHandler.bind(null, io, markersHashMap));

			// This function is used so as to pass parameters in the listener's callback
			function myEvtHandler(io, markersHashMap, data){
				console.log(data);
				for(var i=0; i<data.length; i++){
    				lat = data[i].location.latitude;
    				lng = data[i].location.longitude;
    				console.log(data[i].location.latitude);
    				console.log(data[i].location.longitude);

    				latlng = new google.maps.LatLng(lat, lng);

    				// Find the index of the received vehicle's identification in the vehicles' array
    				var indexName = data[i].name;
    				var indexId = data[i].id;
    				
    				// TODO: Investigate if there is a better way to update a marker's location instead of deleting it and create a new one in the array
    				if(markersHashMap[indexName][indexId] != null){
    					markersHashMap[indexName][indexId].setMap(null);
    					markersHashMap[indexName][indexId] = null;
    				}
    				markersHashMap[indexName][indexId] = new google.maps.Marker({
    					position: latlng,
						map: map
					});
				}
			};
    					
							// geocoder.geocode({'latLng': latlng}, function(results, status) {
	      					// 		if (status == google.maps.GeocoderStatus.OK) {
							// 		if (results[1]) {
							// 			map.setZoom(18);
										
							// 			// newMarker.setMap(map);
							// 			// infowindow.setContent(results[1].formatted_address);
							// 			// infowindow.open(map, newMarker);
							// 		} 
							// 		else {
							// 			alert('No results found');
							// 		}
							// 	}
							// 	else {
							// 		alert('Geocoder failed due to: ' + status);
							// 	}
							// });  				
     	</script>

		<style>
			#panel {
				position: absolute;
				top: 5px;
				left: 50%;
				margin-left: -180px;
				width: 350px;
				z-index: 5;
				background-color: #fff;
				padding: 5px;
				border: 1px solid #999;
			}
			#latlng {
				width: 235px;
			}
		</style>
	</head>

	<body>
		<!-- <div id="panel">
			<input id="ajaxVehicleName" type="text" value="1">
			<input type="button" value="AJAX: Vehicle ID " onclick="codeLatLngAjax()">
	    	<input id="socketVehicleName" type="text" value="1">
			<input type="button" value="SOCKET: Vehicle ID " onclick="codeLatLngSocket()">
	    </div> -->
	    <div id="map-canvas"></div>
	</body>
</html>