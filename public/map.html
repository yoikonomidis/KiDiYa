<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
		<meta charset="utf-8">
		<title>Reverse Geocoding</title>
		<style>
			html, body, #map-canvas {
			height: 100%;
			margin: 0px;
			padding: 10px
			}
			#panel {
				position: absolute;
				top: 5px; 
				left: 50%;
	 			margin-left: -180px;
				z-index: 5;
				background-color: #fff;
			padding: 5px;
					border: 1px solid #999;
			}
		</style>
		<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
		<script src="http://localhost:3000/socket.io/socket.io.js"></script>
		<script>
			var geocoder;
			var map;
			var infowindow = new google.maps.InfoWindow();
			var marker = new google.maps.Marker();
			var marker;
			
			function initialize() {
				geocoder = new google.maps.Geocoder();
				var latlng = new google.maps.LatLng(52.0236377,4.3533367);
				var mapOptions = {
					zoom: 18,
					center: latlng,
					mapTypeId: 'roadmap'
				}
				map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
			}

			function codeLatLngAjax() {
				var lat;
				var lng;
				var latlng;
				var ajaxVehicleName = document.getElementById('ajaxVehicleName').value;

				$(document).ready(function(){
					$.ajax({
	 					url: 'http://localhost:3000/getVehicleLocationAjax',
						type: 'GET',
						dataType: 'json',
						data: {"name": ajaxVehicleName},
						error: function(xhr,status, error){
							console.log(status);
						},
						success: function (result) {
							console.log(result);
							lat = result[0].location.latitude;
	 						lng = result[0].location.longitude;
							latlng = new google.maps.LatLng(lat, lng);
							geocoder.geocode({'latLng': latlng}, function(results, status) {
	          					if (status == google.maps.GeocoderStatus.OK) {
									if (results[1]) {
										map.setZoom(18);
										marker = new google.maps.Marker({
											position: latlng,
											map: map
										});
										infowindow.setContent(results[1].formatted_address);
										infowindow.open(map, marker);
									} 
									else {
										alert('No results found');
									}
								}
								else {
									alert('Geocoder failed due to: ' + status);
								}
							});
						}
					});
				});
			}
			google.maps.event.addDomListener(window, 'load', initialize);
		</script>
		<script>
			// //if io.connect is moved in the function, the connection breaks after use.
			// io = io.connect();
   //  		function codeLatLngSocket(){
   //  			var lat;
			// 	var lng;
			// 	var latlng;
   //  			var socketVehicleName = document.getElementById('socketVehicleName').value;
   //  			$(document).ready(function(){
			// 		console.log("CLIENT");
   //  				io.emit('getVehicleLocation2',{name: socketVehicleName});
   //  				io.on('talk', function(data){
   //  					console.log(data);
   //  					lat = data[0].location.latitude;
   //  					lng = data[0].location.longitude;
   //  					latlng = new google.maps.LatLng(lat, lng);
			// 				geocoder.geocode({'latLng': latlng}, function(results, status) {
	  //         					if (status == google.maps.GeocoderStatus.OK) {
			// 						if (results[1]) {
			// 							map.setZoom(18);
			// 							marker = new google.maps.Marker({
			// 								position: latlng,
			// 								map: map
			// 							});
			// 							infowindow.setContent(results[1].formatted_address);
			// 							infowindow.open(map, marker);
			// 						} 
			// 						else {
			// 							alert('No results found');
			// 						}
			// 					}
			// 					else {
			// 						alert('Geocoder failed due to: ' + status);
			// 					}
			// 				});
   //  					console.log(data[0].location.latitude);
   //  					console.log(data[0].location.longitude);
   //  				});	
   //  			});
   //  		}
   //  		google.maps.event.addDomListener(window, 'load', initialize);
     	</script>

     	<script>
     		io = io.connect();
     		// room = prompt('type a room name');
     		var socketVehicleName = 1;
			// Emit ready event with room name.
			io.emit('getVehicleLocation', socketVehicleName);

			// Listen for the announce event.
			io.on('talk', function(data){
    					console.log(data);
    					lat = data[0].location.latitude;
    					lng = data[0].location.longitude;
    					latlng = new google.maps.LatLng(lat, lng);
							geocoder.geocode({'latLng': latlng}, function(results, status) {
	          					if (status == google.maps.GeocoderStatus.OK) {
									if (results[1]) {
										map.setZoom(18);
										marker = new google.maps.Marker({
											position: latlng,
											map: map
										});
										infowindow.setContent(results[1].formatted_address);
										infowindow.open(map, marker);
									} 
									else {
										alert('No results found');
									}
								}
								else {
									alert('Geocoder failed due to: ' + status);
								}
							});
    					console.log(data[0].location.latitude);
    					console.log(data[0].location.longitude);
    				});
     	</script>

		<style>
			#panel {
				position: absolute;
				top: 5px;
				left: 50%;
				margin-left: -180px;
				width: 350px;
				z-index: 5;
				background-color: #fff;
				padding: 5px;
				border: 1px solid #999;
			}
			#latlng {
				width: 235px;
			}
		</style>
	</head>

	<body>
		<div id="panel">
			<input id="ajaxVehicleName" type="text" value="1">
			<input type="button" value="AJAX: Vehicle ID " onclick="codeLatLngAjax()">
	    	<input id="socketVehicleName" type="text" value="1">
			<input type="button" value="SOCKET: Vehicle ID " onclick="codeLatLngSocket()">
	    </div>
	    <div id="map-canvas"></div>
	</body>
</html>